<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>实习打卡水印相机</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #007aff;
            --background-color: #1c1c1e;
            --text-color: #ffffff;
            --surface-color: #2c2c2e;
            --button-hover: #0056b3;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 15px;
        }

        #permission-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
        }

        #permission-screen h2 {
            margin-bottom: 10px;
        }

        #permission-screen p {
            margin-bottom: 20px;
            color: #a0a0a0;
        }

        .tutorial-item {
            display: flex;
            align-items: flex-start;
            text-align: left;
            margin-bottom: 15px;
            width: 100%;
            max-width: 350px;
        }

        .tutorial-item svg {
            flex-shrink: 0;
            width: 30px;
            height: 30px;
            margin-right: 15px;
            fill: #a0a0a0;
        }

        .tutorial-item .step-text {
            color: #e0e0e0;
            line-height: 1.4;
        }

        #app-screen {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .video-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #camera-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            cursor: pointer;
            padding: 20px;
            color: #aaa;
        }

        #camera-error svg {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            fill: #777;
        }

        #watermark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            flex-shrink: 0;
        }

        .button, button {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            -webkit-appearance: none;
        }

        button:active {
            transform: scale(0.95);
        }

        #capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid var(--primary-color);
            padding: 0;
        }

        .icon-btn {
            background-color: var(--surface-color);
            padding: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            transition: background-color 0.2s;
        }

        .icon-btn:hover {
            background-color: #3f3f41;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 15px;
            border-radius: 12px;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #preview-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 斜45度水印样式 */
        .diagonal-watermark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
            overflow: hidden;
        }

        .watermark-text {
            position: absolute;
            color: white;
            font-size: 24px;
            font-weight: bold;
            transform: rotate(-45deg);
            white-space: nowrap;
        }
    </style>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '71b5ee377b7d68bf88df466de6ef72c9',
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=7fc18f454c40c665824234fb3a2b1113&plugin=AMap.Geolocation,AMap.Geocoder"></script>
</head>
<body>
    <div class="container">
        <div id="permission-screen">
            <h2>欢迎使用打卡相机</h2>
            <p>请授予摄像头权限以开始拍照</p>
            <div class="space-y-4 text-left p-4 rounded-lg bg-gray-800 border border-gray-700 max-w-sm w-full mx-auto mb-6">
                <div class="tutorial-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"></path><path d="M14 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1"></path><path d="m17 12-2-2-2 2"></path><path d="m17 12 2-2 2 2"></path><path d="m7 12 2 2 2-2"></path><path d="m7 12-2 2-2-2"></path></svg>
                    <div class="step-text">
                        <span class="font-bold">切换镜头：</span>
                        <span>如果你有多个摄像头，点击此按钮可以切换前后摄像头。</span>
                    </div>
                </div>
                <div class="tutorial-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
                    <div class="step-text">
                        <span class="font-bold">获取定位：</span>
                        <span>点击此按钮可以获取你的当前位置信息，并作为水印添加到照片上。</span>
                        <br>
                        <span class="text-xs text-gray-400">本功能使用高德地图SDK。</span>
                    </div>
                </div>
                <div class="tutorial-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
                    <div class="step-text">
                        <span class="font-bold">水印显示：</span>
                        <span>时间、日期、位置和水印名称将显示在照片下方居中位置。</span>
                    </div>
                </div>
                <div class="tutorial-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                    <div class="step-text">
                        <span class="font-bold">拍照按钮：</span>
                        <span>中间的圆形大按钮，点击即可拍摄照片，并自动添加水印。</span>
                    </div>
                </div>
            </div>
            <button id="request-permission-btn" class="button">启动相机</button>
        </div>

        <div id="app-screen" class="hidden">
            <div class="video-container">
                <video id="video" playsinline autoplay muted></video>
                <div id="diagonal-watermark" class="diagonal-watermark"></div>
                <canvas id="watermark-overlay"></canvas>
                <div id="camera-error" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0-5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3ZM10.5 2h3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5ZM12 4a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3Z"/><path d="M2 5.5A2.5 2.5 0 0 1 4.5 3H7v1.5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V3h2.5A2.5 2.5 0 0 1 22 5.5v13A2.5 2.5 0 0 1 19.5 21h-15A2.5 2.5 0 0 1 2 18.5v-13ZM20 5.5a.5.5 0 0 0-.5-.5h-15a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5v-13Z"/></svg>
                    <p>摄像头权限获取失败<br>点击此处重试</p>
                </div>
            </div>
            <div class="controls">
                <button id="getLocationBtn" class="icon-btn" title="获取位置">
                    <div class="flex items-center justify-center h-full w-full">
                        <svg id="location-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
                        <div id="location-spinner" class="loading-spinner hidden"></div>
                    </div>
                </button>

                <button id="capture-btn" title="拍照"></button>

                <button id="switch-camera-btn" class="icon-btn" title="切换摄像头">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"></path><path d="M14 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1"></path><path d="m17 12-2-2-2 2"></path><path d="m17 12 2-2 2 2"></path><path d="m7 12 2 2 2-2"></path><path d="m7 12-2 2-2-2"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="modal hidden">
        <div class="modal-content">
            <img id="preview-image" alt="打卡照片预览">
            <p id="wechat-save-tip" class="hidden text-gray-400 mt-2 text-sm">长按图片可保存</p>
            <div class="modal-actions mt-4">
                <button id="close-modal-btn" class="button">关闭</button>
                <button id="clock-in-btn" class="button bg-green-500 hover:bg-green-600">打卡</button>
                <a id="download-link" download><button class="button">下载图片</button></a>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-xs text-center shadow-xl">
            <h3 id="messageTitle" class="text-lg font-bold mb-2"></h3>
            <p id="messageText" class="text-gray-700 mb-4"></p>
            <button onclick="closeMessageBox()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full">
                确定
            </button>
        </div>
    </div>

    <canvas id="photo-canvas" class="hidden"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const permissionScreen = document.getElementById('permission-screen');
            const appScreen = document.getElementById('app-screen');
            const requestPermissionBtn = document.getElementById('request-permission-btn');

            const video = document.getElementById('video');
            const watermarkOverlay = document.getElementById('watermark-overlay');
            const diagonalWatermark = document.getElementById('diagonal-watermark');
            const photoCanvas = document.getElementById('photo-canvas');
            const cameraError = document.getElementById('camera-error');

            const captureBtn = document.getElementById('capture-btn');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const locationIcon = document.getElementById('location-icon');
            const locationSpinner = document.getElementById('location-spinner');
            const switchCameraBtn = document.getElementById('switch-camera-btn');

            const previewModal = document.getElementById('preview-modal');
            const previewImage = document.getElementById('preview-image');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const clockInBtn = document.getElementById('clock-in-btn');
            const downloadLink = document.getElementById('download-link');
            const wechatSaveTip = document.getElementById('wechat-save-tip');

            const messageBox = document.getElementById('messageBox');
            const messageTitle = document.getElementById('messageTitle');
            const messageText = document.getElementById('messageText');

            let currentStream;
            let availableCameras = [];
            let selectedDeviceId = null;
            let watermarkTimer;

            let locationInfo = {
                text: '位置信息待获取',
                lng: null,
                lat: null,
            };

            const dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];

            // 显示消息框
            function showMessageBox(title, text) {
                messageTitle.textContent = title;
                messageText.textContent = text;
                messageBox.classList.remove('hidden');
                messageBox.classList.add('flex');
            }

            // 关闭消息框
            window.closeMessageBox = function() {
                messageBox.classList.remove('flex');
                messageBox.classList.add('hidden');
            }

            // 存入 Cookie
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + d.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }

            // 获取 Cookie
            function getCookie(name) {
                const cname = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const ca = decodedCookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(cname) === 0) {
                        return c.substring(cname.length, c.length);
                    }
                }
                return "";
            }

            // 获取可用摄像头列表
            async function getCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    availableCameras = devices.filter(device => device.kind === 'videoinput');

                    if (availableCameras.length > 1) {
                        switchCameraBtn.classList.remove('hidden');
                    } else {
                        switchCameraBtn.classList.add('hidden');
                    }

                    const savedDeviceId = getCookie('selectedDeviceId');
                    if (savedDeviceId && availableCameras.find(cam => cam.deviceId === savedDeviceId)) {
                        selectedDeviceId = savedDeviceId;
                    } else if (availableCameras.length > 0) {
                        const backCamera = availableCameras.find(cam => 
                            cam.label.toLowerCase().includes('back') || 
                            cam.label.toLowerCase().includes('environment') || 
                            cam.label.toLowerCase().includes('后置')
                        );
                        selectedDeviceId = backCamera ? backCamera.deviceId : availableCameras[0].deviceId;
                    }
                } catch (err) {
                    console.error("无法获取设备列表:", err);
                    switchCameraBtn.classList.add('hidden');
                }
            }

            // 停止当前摄像头流
            function stopCurrentStream() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
            }

            // 启动摄像头
            async function startCamera(deviceId = null) {
                stopCurrentStream();
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    // 修复 bug: 成功获取流之后再次检查设备列表，确保切换按钮显示
                    await getCameras()
